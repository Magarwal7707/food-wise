<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Food Wise ‚Äì Zero-Waste Campus Meals</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#00A699">
  <link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;Food Wise&quot;,&quot;short_name&quot;:&quot;FoodWise&quot;,&quot;start_url&quot;:&quot;/&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;background_color&quot;:&quot;#00A699&quot;,&quot;theme_color&quot;:&quot;#00A699&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://cdn-icons-png.flaticon.com/512/1046/1046857.png&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/png&quot;}]}">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/1046/1046857.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --page-bg: #f7f9fc;
      --card: #ffffff;
      --primary: #00A699;
      --primary-dark: #008b7d;
      --text-dark: #222;
      --text-light: #555;
      --border: #e5e7eb;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 24px;
      --transition: .3s cubic-bezier(.4,0,.2,1);
    }
    body.dark {
      --page-bg: #121212;
      --card: #1e1e1e;
      --text-dark: #f1f1f1;
      --text-light: #bbb;
      --border: #333;
      --shadow: 0 10px 30px rgba(0,0,0,.4);
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
        font-family: 'Inter', system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: var(--page-bg);
        color: var(--text-dark);
        line-height: 1.6;
        min-height: 100vh;
        transition: background var(--transition), color var(--transition);
    }
    header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        padding: 3rem 1rem 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    header::after {
        content: '';
        position: absolute;
        inset: 0;
        background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        animation: slide 60s linear infinite;
    }
    @keyframes slide {
        0% { transform: translate(0,0); }
        100% { transform: translate(-60px,-60px); }
    }
    .header-container {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1.5rem;
        position: relative;
        z-index: 2;
    }
    #logo {
        font-size: clamp(2.5rem, 6vw, 3.8rem);
        font-weight: 800;
        letter-spacing: 1px;
        text-shadow: 2px 2px 0 rgba(0,0,0,.15);
    }
    .theme-toggle {
        background: rgba(255,255,255,.15);
        border: 2px solid rgba(255,255,255,.3);
        color: #fff;
        font-size: 2.2rem;
        cursor: pointer;
        border-radius: 50%;
        width: 52px;
        height: 52px;
        backdrop-filter: blur(4px);
        transition: background var(--transition), transform var(--transition);
    }
    .theme-toggle:active {
        transform: scale(.92);
    }
    #impactBar {
        margin-top: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: .5px;
    }
    #impactBar span {
        color: #FFE477;
    }
    .hero {
        width: 100%;
        height: 35vh;
        min-height: 200px;
        background: url("https://images.unsplash.com/photo-1498837167922-ddd27525d352?auto=format&fit=crop&w=1600&q=80") center/cover no-repeat;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: clamp(1.4rem, 4vw, 2.4rem);
        text-align: center;
        position: relative;
        border-radius: 0 0 40px 40px;
        margin-bottom: 3rem;
    }
    .hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background: rgba(0,0,0,.45);
        border-radius: 0 0 40px 40px;
    }
    .hero span {
        position: relative;
        z-index: 2;
        font-weight: 700;
        animation: fadeInUp 1s ease;
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .container {
        padding: 0 2vw;
    }
    /* zig-zag masonry grid */
    .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        grid-auto-flow: dense;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto 3rem;
    }
    .card {
        background: var(--card);
        border: 1.5px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 2.8rem 2.2rem 2.2rem;
        display: flex;
        flex-direction: column;
        gap: 1.3rem;
        min-height: 260px;
        transition: transform var(--transition), box-shadow var(--transition);
        animation: popIn .6s ease backwards;
        position: relative;
        overflow: hidden;
    }
    .card:nth-child(even) {
        transform: translateY(12px);
    }
    @keyframes popIn {
        from { opacity: 0; transform: scale(.9); }
        to { opacity: 1; transform: scale(1); }
    }
    .card:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0,0,0,.12);
    }
    .card h3 {
        margin: 0 0 .6rem;
        color: var(--primary);
        font-size: 1.3rem;
        font-weight: 700;
    }
    .card p {
        color: var(--text-light);
        font-size: 1.05rem;
        flex: 1;
    }
    /* teal gradient button */
    .card button {
        margin-top: auto;
        border: none;
        border-radius: 30px;
        padding: 1.1rem 2.2rem;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        box-shadow: 0 4px 14px rgba(0, 166, 153, .4);
        transition: transform var(--transition), box-shadow var(--transition);
        position: relative;
        overflow: hidden;
    }
    .card button::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, .3);
        transform: translate(-50%, -50%);
        transition: width .4s, height .4s;
    }
    .card button:active::after {
        width: 300px;
        height: 300px;
    }
    .card button:active {
        transform: scale(.96);
    }
    footer {
        text-align: center;
        padding: 2.5rem 1rem 1.5rem;
        font-size: .98rem;
        color: var(--text-light);
        margin-top: 3rem;
    }

    /* ---------- modals (glass + larger) ---------- */
    .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .55);
        backdrop-filter: blur(6px);
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    .modal.active {
        display: flex;
    }
    .modal-content {
        background: rgba(var(--card), .85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, .2);
        border-radius: 32px;
        padding: 3.5rem 3rem 2.5rem;
        width: 96vw;
        max-width: 520px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, .25);
        text-align: center;
        position: relative;
        animation: modalPop .4s cubic-bezier(.4, 0, .2, 1);
    }
    @keyframes modalPop {
        from { opacity: 0; transform: scale(.85) translateY(20px); }
        to { opacity: 1; transform: scale(1) translateY(0); }
    }
    .modal-content h3 {
        color: var(--primary);
        margin-bottom: 1.2rem;
        font-size: 1.4rem;
    }
    .close {
        position: absolute;
        top: 1.2rem;
        right: 1.5rem;
        font-size: 2.4rem;
        color: var(--text-light);
        background: none;
        border: none;
        cursor: pointer;
        transition: color var(--transition);
    }
    .close:hover {
        color: var(--accent);
    }
    .pill {
        border: none;
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: #fff;
        padding: 1rem 2.2rem;
        border-radius: 30px;
        font-weight: 700;
        font-size: 1.05rem;
        cursor: pointer;
        margin: 4px;
        transition: transform var(--transition), box-shadow var(--transition);
        box-shadow: 0 4px 14px rgba(0, 166, 153, .4);
    }
    .pill:active {
        transform: scale(.96);
    }
    .pill.sand {
        background: linear-gradient(135deg, #ff9a44 0%, #e07a3c 100%);
        box-shadow: 0 4px 14px rgba(255, 154, 68, .4);
    }
    /* larger staff table modal */
    #staffModal .modal-content {
        max-width: 900px;
        width: 98vw;
        padding: 2.5rem;
    }
    #todayList {
        max-height: 50vh;
        overflow-x: auto;
        margin-top: 1rem;
    }
    #todayList table {
        width: 100%;
        border-collapse: collapse;
        font-size: .95rem;
    }
    #todayList th,
    #todayList td {
        padding: .6rem .5rem;
        border: 1px solid var(--border);
    }
    #todayList th {
        background: var(--primary);
        color: #fff;
    }
    #todayList tr:nth-child(even) {
        background: rgba(0, 166, 153, .05);
    }
    /* clean input */
    .modal-content input[type="text"] {
        width: 100%;
        padding: 1rem 1.2rem;
        border: 2px solid var(--border);
        border-radius: 12px;
        font-size: 1.05rem;
        background: var(--page-bg);
        color: var(--text-dark);
        transition: border-color var(--transition);
    }
    .modal-content input[type="text"]:focus {
        outline: none;
        border-color: var(--primary);
    }
    /* noscript box */
    .noscript-box {
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1.5rem;
        margin: 2rem auto;
        max-width: 900px;
        background: var(--card);
    }
    .noscript-box ul {
        list-style: none;
        padding: 0;
    }
    .noscript-box li {
        margin: .5rem 0;
    }
    .noscript-box a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 600;
    }
    .noscript-box a:hover {
        text-decoration: underline;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-container">
      <span id="logo">Food Wise</span>
      <button class="theme-toggle" id="themeToggleBtn" title="Toggle dark mode">üåô</button>
    </div>
    <div id="impactBar">üå± <span id="kg">0</span> kg meals saved this month = <span id="plates">0</span> plates donated</div>
  </header>

  <section class="hero">
    <span>‚ÄúEvery bite counts ‚Äì let‚Äôs feed bellies, not bins.‚Äù</span>
  </section>

  <main class="container">
    <div class="grid">
      <div class="card">
        <h3>üîÑ Update Tomorrow‚Äôs Meal Plan</h3>
        <p>Mark your presence for tomorrow. Helps us cook just enough and cut waste.</p>
        <button id="enrollBtn">Update Meal Plan</button>
      </div>
      <div class="card">
        <h3>üìä Diet-Chart Generator</h3>
        <p>Get macro recommendations based on today‚Äôs menu and your activity.</p>
        <button id="dietBtn">Diet Chart</button>
      </div>
      <div class="card">
        <h3>üìã View your Mess Menu</h3>
        <p>Instantly see today‚Äôs food offerings for your hostel.</p>
        <button id="menuBtn">View Menu</button>
      </div>
      <div class="card">
        <h3>üí¨ Give Feedback</h3>
        <p>Quick form ‚Äì help us improve with your honest feedback.</p>
        <button id="feedbackBtn">Feedback</button>
      </div>
      <div class="card">
        <h3>üë®‚Äçüç≥ Mess Staff Info</h3>
        <p>Live dashboard & trend for mess attendance and kitchen staff.</p>
        <button id="staffBtn">Staff Dashboard</button>
      </div>
    </div>

    <!-- ===== NOSCRIPT FALLBACK ===== -->
    <noscript>
      <div class="noscript-box">
        <h3>Staff Dashboard (raw JSON links)</h3>
        <p>If JavaScript is disabled, open each date link below; the browser will show the raw data.</p>
        <ul>
          <!-- 7 calendar days starting today -->
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-12.json" target="_blank" rel="noopener">2025-11-12</a></li>
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-13.json" target="_blank" rel="noopener">2025-11-13</a></li>
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-14.json" target="_blank" rel="noopener">2025-11-14</a></li>
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-15.json" target="_blank" rel="noopener">2025-11-15</a></li>
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-16.json" target="_blank" rel="noopener">2025-11-16</a></li>
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-17.json" target="_blank" rel="noopener">2025-11-17</a></li>
          <li><a href="https://foodwise-be544-default-rtdb.firebaseio.com/meals/2025-11-18.json" target="_blank" rel="noopener">2025-11-18</a></li>
        </ul>
      </div>
    </noscript>
  </main>

  <footer>Made with ‚ù§Ô∏è by students, for students. | <a href="#" style="color:var(--primary)">Learn More</a></footer>

  <!-- ====================  ALL MODALS  ==================== -->
  <!-- 1. ENROLL -->
  <div id="enrollModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="enrollModalTitle">
    <div class="modal-content">
      <button class="close" data-close="enrollModal">&times;</button>
      <h3 id="enrollModalTitle">Enter your Enrollment Number</h3>
      <input id="enrollInput" type="text" placeholder="e.g. 1234567890" maxlength="12" autocomplete="off">
      <div class="modal-actions">
        <button class="pill" id="submitEnroll">Next</button>
      </div>
    </div>
  </div>

  <!-- 2. HOSTEL CHOICE -->
  <div id="hostelModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="hostelModalTitle">
    <div class="modal-content">
      <button class="close" data-close="hostelModal">&times;</button>
      <h3 id="hostelModalTitle">Select your Hostel</h3>
      <div class="modal-actions">
        <button class="pill" data-hostel="Tejas">Tejas</button>
        <button class="pill" data-hostel="Ambaram">Ambaram</button>
        <button class="pill" data-hostel="Vasudha">Vasudha</button>
      </div>
    </div>
  </div>

  <!-- 3. MEAL SELECTION -->
  <div id="mealModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mealModalTitle">
    <div class="modal-content">
      <button class="close" data-close="mealModal">&times;</button>
      <h3 id="mealModalTitle">Which meals would you like tomorrow?<br><small>(pick at least one)</small></h3>
      <form id="mealForm" style="margin:1.2rem 0 1.8rem;text-align:left">
        <label style="display:flex;align-items:center;margin:.6rem 0"><input type="checkbox" value="Breakfast" style="margin-right:12px;width:20px;height:20px">üåÖ Breakfast</label>
        <label style="display:flex;align-items:center;margin:.6rem 0"><input type="checkbox" value="Lunch" style="margin-right:12px;width:20px;height:20px">üç± Lunch</label>
        <label style="display:flex;align-items:center;margin:.6rem 0"><input type="checkbox" value="Dinner" style="margin-right:12px;width:20px;height:20px">üçΩÔ∏è Dinner</label>
      </form>
      <div class="modal-actions">
        <button class="pill" id="confirmMeals">Confirm Meals</button>
      </div>
    </div>
  </div>

  <!-- 4. SUCCESS / ALREADY / OFFLINE -->
  <div id="successModal" class="modal" role="alertdialog" aria-modal="true">
    <div class="modal-content">
      <button class="close" data-close="successModal">&times;</button>
      <h3>‚úÖ Success</h3>
      <p>Your meal plan has been updated! Bon app√©tit!</p>
    </div>
  </div>

  <div id="alreadyModal" class="modal" role="alertdialog" aria-modal="true">
    <div class="modal-content">
      <button class="close" data-close="alreadyModal">&times;</button>
      <h3>Already Registered</h3>
      <p>You already updated for tomorrow. Contact mess manager to revise.</p>
    </div>
  </div>

  <div id="offlineModal" class="modal" role="alertdialog" aria-modal="true">
    <div class="modal-content">
      <button class="close" data-close="offlineModal">&times;</button>
      <h3>‚ö†Ô∏è Offline</h3>
      <p>Please check your internet connection and try again.</p>
    </div>
  </div>

  <!-- 5. DIET-CHART flow -->
  <div id="dietModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="dietModalTitle">
    <div class="modal-content">
      <button class="close" data-close="dietModal">&times;</button>
      <h3 id="dietModalTitle">Choose Activity Level</h3>
      <div class="modal-actions">
        <button class="pill sand" data-level="high">High Burn</button>
        <button class="pill sand" data-level="low">Low Burn</button>
      </div>
    </div>
  </div>

  <div id="hostelModal2" class="modal" role="dialog" aria-modal="true" aria-labelledby="hostelModal2Title">
    <div class="modal-content">
      <button class="close" data-close="hostelModal2">&times;</button>
      <h3 id="hostelModal2Title">Select your Hostel</h3>
      <div class="modal-actions">
        <button class="pill" data-hostel2="Tejas">Tejas</button>
        <button class="pill" data-hostel2="Ambaram">Ambaram</button>
        <button class="pill" data-hostel2="Vasudha">Vasudha</button>
      </div>
    </div>
  </div>

  <div id="mealModal2" class="modal" role="dialog" aria-modal="true" aria-labelledby="mealModal2Title">
    <div class="modal-content">
      <button class="close" data-close="mealModal2">&times;</button>
      <h3 id="mealModal2Title">Select the meal</h3>
      <div class="modal-actions">
        <button class="pill" data-meal2="Breakfast">Breakfast</button>
        <button class="pill" data-meal2="Lunch">Lunch</button>
        <button class="pill" data-meal2="Dinner">Dinner</button>
      </div>
    </div>
  </div>

  <!-- 6. MENU-HOSTEL picker -->
  <div id="menuHostelModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="menuHostelModalTitle">
    <div class="modal-content">
      <button class="close" data-close="menuHostelModal">&times;</button>
      <h3 id="menuHostelModalTitle">Pick your Hostel</h3>
      <div class="modal-actions">
        <button class="pill" data-menu-hostel="Tejas">Tejas</button>
        <button class="pill" data-menu-hostel="Vasudha">Vasudha</button>
        <button class="pill" data-menu-hostel="Ambaram">Ambaram</button>
      </div>
    </div>
  </div>

  <!-- 7. STAFF DASHBOARD -->
  <div id="staffModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="staffDashTitle">
    <div class="modal-content" style="max-width:900px;width:98vw">
      <button class="close" data-close="staffModal">&times;</button>
      <h3 id="staffDashTitle">Live Mess Dashboard</h3>
      <div id="todayList" style="max-height:50vh;overflow-x:auto"></div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
    import { getDatabase, ref, push, onValue } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAVUCiFoFxIGIbTEl0RwFqsAFbBubFzfMY",
      authDomain: "foodwise-be544.firebaseapp.com",
      databaseURL: "https://foodwise-be544-default-rtdb.firebaseio.com",
      projectId: "foodwise-be544",
      storageBucket: "foodwise-be544.firebasestorage.app",
      messagingSenderId: "474184904149",
      appId: "1:474184904149:web:ee47521340386e7625e15c"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    /* ---------- theme ---------- */
    const themeBtn = document.getElementById('themeToggleBtn');
    themeBtn.onclick = () => {
      document.body.classList.toggle('dark');
      themeBtn.textContent = document.body.classList.contains('dark') ? 'üåû' : 'üåô';
      localStorage.setItem('fw-theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    };
    if (localStorage.getItem('fw-theme') === 'dark') {
      document.body.classList.add('dark');
      themeBtn.textContent = 'üåû';
    }

    /* ---------- impact bar ---------- */
    function animate(id, target) {
      const el = document.getElementById(id);
      let i = 0, inc = Math.max(1, Math.floor(target / 60));
      const t = setInterval(() => {
        el.textContent = ++i;
        if (i >= target) clearInterval(t);
      }, 20);
    }
    animate('kg', 100);
    animate('plates', 240);

    /* ---------- modal helpers ---------- */
    function $(q) { return document.querySelector(q); }
    function $$(q) { return document.querySelectorAll(q); }
    function openModal(id) { $('#' + id).classList.add('active'); }
    function closeModal(id) { $('#' + id).classList.remove('active'); }
    $$('.close').forEach(b => b.onclick = () => closeModal(b.dataset.close));
    window.onclick = e => {
      if (e.target.classList.contains('modal')) e.target.classList.remove('active');
    };

    /* ---------- meal plan flow ---------- */
    let enroll = '', hostel = '', meal = '', calorieLevel = '';
    window.addEventListener('DOMContentLoaded', () => {
      enroll = localStorage.getItem('fw-enroll') || '';
      hostel = localStorage.getItem('fw-hostel') || '';
    });

    $('#enrollBtn').onclick = () => { openModal('enrollModal'); $('#enrollInput').focus(); };
    $('#submitEnroll').onclick = () => {
      const val = $('#enrollInput').value.trim();
      if (!val) { alert('Enter enrollment'); return; }
      enroll = val;
      localStorage.setItem('fw-enroll', enroll);
      closeModal('enrollModal');
      openModal('hostelModal');
    };
    $$('[data-hostel]').forEach(btn => btn.onclick = () => {
      hostel = btn.dataset.hostel;
      localStorage.setItem('fw-hostel', hostel);
      closeModal('hostelModal');
      openModal('mealModal');
    });
    $('#confirmMeals').onclick = () => {
      const checked = Array.from($('#mealForm').querySelectorAll('input:checked')).map(cb => cb.value);
      if (!checked.length) { alert('Select at least one meal'); return; }
      meal = checked.join(',');
      closeModal('mealModal');
      const tomorrow = new Date(Date.now() + 86400000).toISOString().slice(0, 10);
      const dayRef = ref(db, 'meals/' + tomorrow);
      onValue(dayRef, dataSnap => {
        const data = dataSnap.val();
        let exists = false;
        if (data) exists = Object.values(data).some(r => r.enroll === enroll);
        if (exists) { openModal('alreadyModal'); return; }
        push(dayRef, { enroll, hostel, meal, at: Date.now() }).then(() => {
          openModal('successModal');
          setTimeout(() => closeModal('successModal'), 2000);
        });
      }, { onlyOnce: true });
    };

    /* ---------- diet-chart flow ---------- */
    $('#dietBtn').onclick = () => openModal('dietModal');
    $$('[data-level]').forEach(btn => btn.onclick = () => {
      calorieLevel = btn.dataset.level;
      closeModal('dietModal');
      openModal('hostelModal2');
    });
    $$('[data-hostel2]').forEach(btn => btn.onclick = () => {
      hostel = btn.dataset.hostel2;
      closeModal('hostelModal2');
      openModal('mealModal2');
    });
    $$('[data-meal2]').forEach(btn => btn.onclick = () => {
      const chosenMeal = btn.dataset.meal2;
      closeModal('mealModal2');
      const sheetId = calorieLevel === 'high' ? 'xxxHighSheet' : 'yyyLowSheet';
      window.open(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:html&sheet=${chosenMeal}`, '_blank', 'noopener');
    });

    /* ---------- menu button ---------- */
    $('#menuBtn').onclick = () => openModal('menuHostelModal');
    $$('[data-menu-hostel]').forEach(btn => btn.onclick = () => {
      const h = btn.dataset.menuHostel;
      closeModal('menuHostelModal');
      window.open(`https://docs.google.com/spreadsheets/d/1MENU_${h}/gviz/tq?tqx=out:html&sheet=Today`, '_blank', 'noopener');
    });

    /* ---------- feedback button ---------- */
    $('#feedbackBtn').onclick = () => window.open('https://docs.google.com/forms/d/e/1FAIpQLSf8yWqkXfxq6uk1k53uqpRw0O7TZUjfg_LNcpOzEhBp4VcH6g/viewform', '_blank', 'noopener');

  /* ---------- staff dashboard (FIXED auth) ---------- */
const staffBtn = $('#staffBtn');
const todayList = $('#todayList');
let staffInterval;

staffBtn.onclick = () => {
  openModal('staffModal');
  loadDateRange();
  staffInterval = setInterval(loadDateRange, 30000);
};
$('[data-close="staffModal"]').onclick = () => {
  closeModal('staffModal');
  clearInterval(staffInterval);
};

function iso(date, offset = 0) {
  const d = new Date(date);
  d.setDate(d.getDate() + offset);
  return d.toISOString().slice(0, 10);
}

function buildTable(label, data) {
  if (!data) return `<h4 style="color:var(--primary);margin:1rem 0 .4rem">${label}</h4><p style="color:#888">No data yet.</p>`;

  const bucket = {};                       // { hostel : { Breakfast: n, Lunch: n, Dinner: n } }
  Object.values(data).forEach(r => {
    const h = r.hostel;
    const meals = r.meal.split(',');       // üëà split "Breakfast,Lunch" ‚Üí ["Breakfast","Lunch"]
    bucket[h] = bucket[h] || { Breakfast: 0, Lunch: 0, Dinner: 0 };
    meals.forEach(m => bucket[h][m.trim()]++);
  });

  let html = `<h4 style="color:var(--primary);margin:1rem 0 .4rem">${label}</h4>
              <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse">
              <thead><tr style="background:var(--primary);color:#fff">
                <th style="padding:.6rem .5rem;text-align:left">Hostel</th>
                <th style="padding:.6rem .5rem;text-align:center">Breakfast</th>
                <th style="padding:.6rem .5rem;text-align:center">Lunch</th>
                <th style="padding:.6rem .5rem;text-align:center">Dinner</th>
                <th style="padding:.6rem .5rem;text-align:center">Total</th>
              </tr></thead><tbody>`;
  ['Tejas', 'Ambaram', 'Vasudha'].forEach(h => {
    if (!bucket[h]) return;
    const b = bucket[h].Breakfast, l = bucket[h].Lunch, d = bucket[h].Dinner, sum = b + l + d;
    html += `<tr>
               <td style="padding:.6rem .5rem;font-weight:600">${h}</td>
               <td style="padding:.6rem .5rem;text-align:center">${b}</td>
               <td style="padding:.6rem .5rem;text-align:center">${l}</td>
               <td style="padding:.6rem .5rem;text-align:center">${d}</td>
               <td style="padding:.6rem .5rem;text-align:center;font-weight:600">${sum}</td>
             </tr>`;
  });
  html += '</tbody></table></div>';
  return html;
}

async function loadDateRange() {
  const today = new Date();
  const labels = [];
  const promises = [];
  for (let i = 0; i < 7; i++) {
    const dayStr = iso(today, i);
    labels.push(dayStr);
    promises.push(
      new Promise((resolve) => {
        onValue(ref(db, 'meals/' + dayStr), snap => resolve(snap.val()), { onlyOnce: true });
      })
    );
  }
  const results = await Promise.all(promises);
  todayList.innerHTML = results.map((data, idx) => buildTable(labels[idx], data)).join('');
}

    /* ---------- PWA service-worker (offline) ---------- */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript,' + encodeURIComponent(`
        const CACHE = 'fw-v1';
        const FILES = ['/'];
        self.addEventListener('install', e => e.waitUntil(caches.open(CACHE).then(c => c.addAll(FILES))));
        self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
      `));
    }
  </script>
</body>
</html>
